---
layout: single
title: "CLI App ä»£ç å¸ƒå±€ (App Layout)"
date: 2020-07-13 11:16:11 +0800
Author: hedzr
tags: [commander, command-line, "command-line-parser", command-line-interface,  getops, posix, posix-compatible, hierarchical-configuration, hierarchy, cli, golang]
categories: golang cmdr guide cli
comments: true
toc: true
header:
  overlay_image: /assets/images/cmdr/help-screen.png
  overlay_filter: rgba(128, 128, 0, 0.3)
excerpt: >-
  Guide and References for cmdr ...
#header:
#  overlay_image: /assets/images/unsplash-image-1.jpg
#  overlay_filter: rgba(0, 0, 0, 0.15)
#  caption: "Photo credit: [**Unsplash**](https://unsplash.com)"
#  actions:
#    - label: "More Info"
#      url: "https://unsplash.com"


---



# CLI app åŠå…¶ä»£ç å¸ƒå±€

ä¸€ä¸ª CLI åº”ç”¨ç¨‹åºæœ‰å¦‚ä¸‹çš„å‘½ä»¤è¡Œæ“ä½œç•Œé¢ï¼š

```bash
app commands [flags] [arguments]
```

`app` è¡¨ç¤ºè¿™ä¸ªåº”ç”¨ç¨‹åºçš„æ–‡ä»¶åã€‚

åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œcmdr ä¼šå°è¯•å°½å¯èƒ½åœ°å®½æ¾è¯†åˆ«ç”¨æˆ·è¾“å…¥ã€‚è¿™æ„å‘³ç€ï¼š

```bash
$ app cmd1 -a -b cmd2 cmd3 -c -d -e file1 file2 file3
```

æ˜¯èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«å‡ºï¼š

1. Commands: cmd1 cmd2 cmd3 ä¸‰çº§å­å‘½ä»¤
2. Flags: -a -b -c -d -e ä¸€ç³»åˆ—æ ‡å¿—
3. Tailed Args: file1 file2 file3 ç­‰å°¾éƒ¨å‚æ•°

å…¶ä¸­ï¼Œè¯†åˆ«å‡ºçš„æ ‡å¿—å¯ä»¥å±äºä»»æ„å‘½ä»¤ï¼šä¸‰çº§å­å‘½ä»¤ä»¥åŠæ ¹å‘½ä»¤ã€‚å¹¶ä¸”ï¼Œå®ƒä»¬çš„è¾“å…¥é¡ºåºæ²¡æœ‰é™å®šï¼Œå¯å‰å¯åã€‚

åŒæ ·é“ç†ï¼Œå¯¹äºçŸ­æ ‡å¿—ç»„åˆæƒ…å½¢æ¥è¯´ï¼Œå•ä¸ªå­—æ¯æˆ–å¤šä¸ªå­—æ¯çš„çŸ­å‚æ•°å¯ä»¥è‡ªç”±åœ°ç»„åˆï¼Œåªè¦æ²¡æœ‰æ­§ä¹‰ï¼Œåˆ™ cmdr å°†ä¼šå¦‚ä½ é¢„æœŸèˆ¬åœ°è¯†åˆ«åˆ°å®ƒä»¬ï¼š

```bash
-avraz == -a -v -ra -z
-raavz == -ra -a -v -z
```





## å‘½ä»¤å’Œå­å‘½ä»¤ï¼ˆCommandsï¼‰

å¯¹äº `cmdr` æ„å»ºçš„ CLI åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œ`commands` æ˜¯ç”±ä½ å®šä¹‰çš„å­å‘½ä»¤æ„æˆï¼Œä¾‹å¦‚ï¼š

- `app ca print`
- `app ca create`
- `app cert create`



## æ ‡å¿—ï¼ˆFlagsï¼‰

`flags` ç”±ä»»æ„å¤šä¸ªæ ‡å¿—ç»„æˆã€‚ä¾‹å¦‚ï¼š

- `app list --retry 5 -rv -n "front-end" --help`

ä½ å¯ä»¥æ··åˆå¤šçº§å­å‘½ä»¤çš„ä»»ä½• `flags`ï¼Œ`cmdr` å°†ä¼šé‡‡ç”¨ä»åº•å±‚åˆ°é¡¶å±‚çš„é¡ºåºå»å°è¯•å®Œæˆ `flags` çš„åŒ¹é…ã€‚å¦‚æœä½ åœ¨å…·æœ‰ä»å±å…³ç³»çš„å­å‘½ä»¤å±‚çº§ä¸­å®šä¹‰äº†ç›¸åŒçš„æ ‡å¿—çš„è¯ï¼Œè¦æ³¨æ„åˆ°é¡¶å±‚çš„æ ‡å¿—å°†æ— æ³•è¢«åŒ¹é…åˆ°ã€‚

ä½†å¯¹äºåŒä¸€ä¸ªå­å‘½ä»¤æ¥è¯´ï¼Œå®ƒçš„æ‰€æœ‰ç›´æ¥æ ‡å¿—æ˜¯ä¸å¯ä»¥é‡å¤çš„ã€‚å¯¹äºè¿™ç±»é‡å¤å®šä¹‰çš„æ ‡å¿—ï¼Œ`cmdr` ä¼šæ‰“å°ä¸€æ¡è­¦å‘Šä¿¡æ¯ï¼Œæé†’ä½ åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒæ•´ç›¸å…³è®¾è®¡ã€‚

> ç›´æ¥å±äºåŒä¸€ä¸ªå‘½ä»¤çš„å­å‘½ä»¤å½¼æ­¤ä¹‹é—´ä¹Ÿä¸èƒ½é‡å¤ï¼ŒåŒæ ·åœ°ä¼šæœ‰ä¸€ä¸ªè­¦å‘Šä¿¡æ¯è¾“å‡ºã€‚

### å†…å»ºæ ‡å¿—

åƒ `--help` (HELP)ï¼Œ`--version`ï¼Œ`--version-simu`ï¼Œ`--verbose` (VERBOSE)ï¼Œ`--debug` (DEBUG) ç­‰æ ‡å¿—ï¼Œæ˜¯å¦‚æ­¤çš„å¸¸ç”¨ï¼Œå› è€Œ cmdr å·²ç»å†…å»ºäº†å®ƒä»¬ã€‚

å¯ä»¥å‚è€ƒ [é«˜çº§ç‰¹æ€§ - å†…å»ºå‘½ä»¤å’Œæ ‡å¿—](Z15.adv.html#builtin-commands-and-flags) è·å¾—å®Œæ•´çš„æè¿°ã€‚

ç”±äºç¯å¢ƒå˜é‡çš„å¯ç”¨æ€§ï¼Œæ‰€ä»¥åƒ `--help` è¿™æ ·çš„æŸ¥çœ‹å‘½ä»¤ã€æ ‡å¿—ç”¨æ³•çš„ä¸“ç”¨æ ‡å¿—ï¼Œå¯ä»¥ä½¿ç”¨å‰ç½®ç¯å¢ƒå˜é‡èµ‹å€¼çš„æ–¹å¼æ¥ä»£æ›¿ï¼š

```bash
$ app cmd1 cmd2 -v --help
$ HELP=1 app cmd1 cmd2 -v
```

ä¸Šè¿°ä¸¤æ¡å‘½ä»¤æ˜¯ç­‰ä»·çš„ã€‚





## å°¾éƒ¨å‚æ•°ï¼ˆArgumentsï¼‰

`arguments` è¡¨ç¤ºå½“ `commands`, `flags` è¢«åŒ¹é…å’Œå¤„ç†å®Œæ¯•ä¹‹åï¼Œå‘½ä»¤è¡Œçš„å‰©ä½™å‚æ•°åˆ—è¡¨ã€‚ä¾‹å¦‚ä½ éœ€è¦ä¸€ä¸ªåƒ gcc ä¸€æ ·æ‰€çš„æ–‡ä»¶åˆ—è¡¨ã€‚åœ¨ `cmdr` ä¸­ï¼Œå¾€å¾€ä¼šå°†å…¶ç§°ä½œ `remained args` æˆ–è€… `tail argument`ï¼Œä½ å¯ä»¥åœ¨ Action æ‰€å®šä¹‰çš„å›è°ƒå‡½æ•°ä¸­ç›´æ¥å–å¾—è¿™ä¸ªæ•°ç»„ï¼š

```go
	root.NewSubCommand("soundex", "snd", "sndx", "sound").
		Action(func(cmd *cmdr.Command, args []string) (err error) {
			for ix, s := range args {
				fmt.Printf("%5d. %s => %s\n", ix, s, cmdr.Soundex(s))
			}
			return
		})
```

ä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬åœ¨å®šä¹‰ä¸€æ¡å‘½ä»¤çš„åŒæ—¶ï¼Œä¹Ÿé€šè¿‡ Action ä¸ºå…¶æŒ‡å®šå“åº”å‡½æ•°ã€‚è¯¥å‡½æ•°è¢«å›è°ƒæ—¶ï¼Œèƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ª `cmd` å¯¹è±¡ä»¥åŠ `remained args` æ•°ç»„ã€‚

> æ­¤æ—¶å¾—åˆ°çš„ `cmd` å¯¹è±¡å®é™…ä¸Šå°±æ˜¯ "soundex" è¿™ä¸ª `*cmdr.Command` å¯¹è±¡ã€‚
>
> å¯¹äºé inline æ–¹å¼å•ç‹¬å®šä¹‰çš„ Action å‡½æ•°æ¥è¯´ï¼Œ`cmd` å¯èƒ½æ˜¯æœ‰ç”¨çš„ã€‚è€ƒè™‘å‡ ä¸ªå‘½ä»¤å…±ç”¨åŒä¸€ä¸ª Action å›è°ƒå‡½æ•°çš„æƒ…å†µï¼Œ`cmd` å°†æœ‰åŠ©äºåŒºåˆ«æ˜¯å“ªä¸€ä¸ª Command å¯¹è±¡è¢«å‘½ä¸­äº†ã€‚



## é€‰é¡¹ï¼ˆOptionsï¼‰

é€‰é¡¹ï¼Œåœ¨ cmdr ä¸­æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„æœ¯è¯­ï¼Œå®ƒè¡¨ç¤ºä¸¤ç§ä¸œè¥¿ï¼š

1. æ¥è‡ªå‘½ä»¤è¡Œçš„ æ ‡å¿—ï¼ˆFlagsï¼‰
2. æ¥è‡ªé…ç½®æ–‡ä»¶çš„ é…ç½®é¡¹ï¼ˆConfig Itemsï¼‰

è¿™ä¸¤ç§ä¸åŒæ¥æºçš„é”®å€¼å¯¹è¢«ç»Ÿä¸€åœ°ç§°ä½œé€‰é¡¹ï¼ˆOptionsï¼‰ï¼Œå®ƒä»¬è¢«å­˜å‚¨åœ¨ Option Store ä¸­ï¼Œå¯ä»¥é‡‡ç”¨ç»Ÿä¸€çš„è®¿é—®æ–¹å¼è¿›è¡Œè¯»å†™ã€‚

```go
var debugMode bool = cmdr.GetR("debug", false)
var stringVal string = cmdr.GetStringR("test.vals.string-val", "hello, world")
var intVal int = cmdr.GetIntR("test.vals.int-val", -1)
var uintVal uint = cmdr.GetUintR("test.vals.uint-val", 99)
var sslice []int64 = cmdr.GetIntSliceR("test.vals.int-slice-val", 5,6,7)
```

> `keyPath` æ˜¯ä¸€ä¸ªå¥ç‚¹ï¼ˆ'.'ï¼‰åˆ†éš”çš„å¤šçº§å­—ç¬¦ä¸²ï¼Œæ¯ä¸€ä¸ªç‰‡æ®µä»£è¡¨ä¸€ä¸ªå±‚çº§ï¼Œå¯¹åº”ç€YAML çš„æ ‘çŠ¶å±‚çº§ç»“æ„ï¼š
>
> ```yaml
> app:
>   debug: true
>   test:
>     vals:
>       string-val:
>       int-val: 9
>       uint-val: 
>       string-slice-val: []
>       int-slice-val: [7,8,9,10]
>       uint-slice-val: []
> ```
>
> 

ä½ å¯ä»¥ä½¿ç”¨ Option Store æä¾›çš„æ ‡å‡†ç±»å‹æŠ½å–å‡½æ•°æ¥è¯»å†™ä¸€ä¸ª `keyPath` çš„å€¼ï¼Œä¹Ÿå¯ä»¥å°†ä¸€ä¸ª `keyPath` åŠå…¶ä¸‹çº§èŠ‚ç‚¹æ•´ä½“æŠ½å‡ºä¸ºä¸€ä¸ª Mapï¼Œç”šè‡³æ˜¯ç›´æ¥æŠ½å‡ºä¸ºç»“æ„ï¼š

```go
var m map[string]interface{} = cmdr.GetMapR("test.vals")
var i interface{} = cmdr.Get("test.vals")

type ServerConfig struct {
  Port int
  HttpMode int
  EnableTLS bool
}
var serverConfig = new(ServerConfig)
cmdr.GetSectionFrom("server", &serverConfig)
assert serverConfig.Port == 7100

```







## åº”ç”¨ç¨‹åºç»“æ„ï¼ˆApp Layoutï¼‰

ç»¼ä¸Šï¼Œä¸€ä¸ª CLI åº”ç”¨ç¨‹åºçš„å…¸å‹ç¼–ç å¸ƒå±€å¯ä»¥æ˜¯è¿™æ ·ï¼š

```go
package main

import (
	"fmt"
	"github.com/hedzr/cmdr"
	cmdr_examples "github.com/hedzr/cmdr-examples"
	"gopkg.in/hedzr/errors.v2"
)

func main() {
	Entry()
}

func Entry() {
	if err := cmdr.Exec(buildRootCmd(), 
              cmdr.WithUnhandledErrorHandler(onUnhandledErrorHandler),
              ); err != nil {
		fmt.Printf("error: %+v\n", err)
	}
}

func onUnhandledErrorHandler(err interface{}) {
	if cmdr.GetBoolR("enable-ueh") {
		dumpStacks()
		return
	}

	panic(err)
}

func dumpStacks() {
	fmt.Printf("=== BEGIN goroutine stack dump ===\n%s\n=== END goroutine stack dump ===\n", errors.DumpStacksAsString(true))
}

func buildRootCmd() (rootCmd *cmdr.RootCommand) {
	root := cmdr.Root(appName, cmdr_examples.Version).
		Copyright(copyright, "hedzr").
		Description(desc, longDesc).
		Examples(examples)
	rootCmd = root.RootCommand()

	cmdr.NewBool(false).
		Titles("enable-ueh", "ueh").
		EnvKeys("ENABLE_UEH").
		Description("Enables the unhandled exception handler?").
		AttachTo(root)

	soundex(root)
	panicTest(root)

	return
}

func soundex(root cmdr.OptCmd) {
	// soundex

	root.NewSubCommand("soundex", "snd", "sndx", "sound").
		Description("soundex test").
		Group("Test").
		TailPlaceholder("[text1, text2, ...]").
		Action(func(cmd *cmdr.Command, args []string) (err error) {
			for ix, s := range args {
				fmt.Printf("%5d. %s => %s\n", ix, s, cmdr.Soundex(s))
			}
			return
		})
}

func panicTest(root cmdr.OptCmd) {
	// panic test

	pa := root.NewSubCommand("panic-test", "pa").
		Description("test panic inside cmdr actions", "").
		Group("Test")

	val := 9
	zeroVal := zero

	pa.NewSubCommand("division-by-zero", "dz").
		Description("").
		Group("Test").
		Action(func(cmd *cmdr.Command, args []string) (err error) {
			fmt.Println(val / zeroVal)
			return
		})

	pa.NewSubCommand("panic", "pa").
		Description("").
		Group("Test").
		Action(raisePanic)
}

func raisePanic(cmd *cmdr.Command, args []string) (err error) {
  panic(9)
  return
}

const (
	appName   = "simple"
	copyright = "simple is an effective devops tool"
	desc      = "simple is an effective devops tool. It make an demo application for `cmdr`."
	longDesc  = "simple is an effective devops tool. It make an demo application for `cmdr`."
	examples  = `
$ {{.AppName}} gen shell [--bash|--zsh|--auto]
  generate bash/shell completion scripts
$ {{.AppName}} gen man
  generate linux man page 1
$ {{.AppName}} --help
  show help screen.
`
	overview = ``

	zero = 0
)
```

è¿™ä¸ªç¤ºä¾‹å¯ä»¥åœ¨ <https://github.com/hedzr/cmdr-examples/blob/master/examples/simple/main.go> è¢«æ‰¾åˆ°ã€‚





ğŸ”š



